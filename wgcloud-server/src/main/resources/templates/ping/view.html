<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PING监测任务详情</title>
    <link rel="stylesheet" href="/AdminLTE/plugins/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="/AdminLTE/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="/AdminLTE/plugins/chart.js/Chart.min.css">
    <style>
        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }
        .status-disabled { color: #6c757d; }
        .metric-card { margin-bottom: 15px; }
        .metric-value { font-size: 24px; font-weight: bold; }
        .metric-label { font-size: 14px; color: #666; }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
    <!-- 引入通用的侧边栏 -->
    <div th:replace="common/aside :: aside"></div>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <!-- Content Header -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0" id="taskTitle">任务详情</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/index">首页</a></li>
                            <li class="breadcrumb-item"><a href="/ping/list">PING监测</a></li>
                            <li class="breadcrumb-item active">任务详情</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <!-- 任务基本信息 -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">任务信息</h3>
                                <div class="card-tools">
                                    <button class="btn btn-warning btn-sm" onclick="editTask()" id="editBtn">
                                        <i class="fas fa-edit"></i> 编辑
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="testPing()" id="testBtn">
                                        <i class="fas fa-network-wired"></i> 立即测试
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="refreshData()">
                                        <i class="fas fa-sync"></i> 刷新
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-borderless">
                                            <tr>
                                                <td><strong>任务名称:</strong></td>
                                                <td id="taskName">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>任务描述:</strong></td>
                                                <td id="taskDescription">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>监测间隔:</strong></td>
                                                <td id="pingInterval">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>超时时间:</strong></td>
                                                <td id="timeout">-</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-borderless">
                                            <tr>
                                                <td><strong>任务状态:</strong></td>
                                                <td id="taskStatus">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>线程状态:</strong></td>
                                                <td id="threadStatus">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>记录策略:</strong></td>
                                                <td id="recordStrategy">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>创建时间:</strong></td>
                                                <td id="createTime">-</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <strong>监测IP列表:</strong>
                                        <div id="ipList" class="mt-2" style="background: #f4f4f4; padding: 10px; border-radius: 4px;">-</div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3" id="tagsRow" style="display: none;">
                                    <div class="col-12">
                                        <strong>标签:</strong>
                                        <div id="tags" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 实时状态卡片 -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">实时状态</h3>
                            </div>
                            <div class="card-body">
                                <div id="realtimeStatus">
                                    <div class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 统计信息 -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="small-box bg-info">
                            <div class="inner">
                                <h3 id="totalPings">-</h3>
                                <p>总监测次数</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-network-wired"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="small-box bg-success">
                            <div class="inner">
                                <h3 id="successRate">-</h3>
                                <p>成功率</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="small-box bg-warning">
                            <div class="inner">
                                <h3 id="avgResponseTime">-</h3>
                                <p>平均响应时间</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="small-box bg-danger">
                            <div class="inner">
                                <h3 id="lastFailure">-</h3>
                                <p>最后失败时间</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图表区域 -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">响应时间趋势</h3>
                                <div class="card-tools">
                                    <select id="chartTimeRange" class="form-control form-control-sm" style="width: auto;">
                                        <option value="1">最近1小时</option>
                                        <option value="6">最近6小时</option>
                                        <option value="24" selected>最近24小时</option>
                                        <option value="168">最近7天</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="responseTimeChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">可用性统计</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="availabilityChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 监测结果列表 -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">监测结果</h3>
                                <div class="card-tools">
                                    <div class="input-group input-group-sm" style="width: 300px;">
                                        <select id="filterIp" class="form-control">
                                            <option value="">所有IP</option>
                                        </select>
                                        <select id="filterStatus" class="form-control">
                                            <option value="">所有状态</option>
                                            <option value="1">成功</option>
                                            <option value="0">失败</option>
                                        </select>
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-default" onclick="loadResults()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped">
                                        <thead>
                                        <tr>
                                            <th>IP地址</th>
                                            <th>状态</th>
                                            <th>响应时间</th>
                                            <th>丢包率</th>
                                            <th>监测时间</th>
                                            <th>错误信息</th>
                                        </tr>
                                        </thead>
                                        <tbody id="resultsTableBody">
                                        <!-- 数据将通过AJAX加载 -->
                                        </tbody>
                                    </table>
                                </div>

                                <!-- 分页 -->
                                <div class="row">
                                    <div class="col-sm-12 col-md-5">
                                        <div class="dataTables_info" id="pageInfo"></div>
                                    </div>
                                    <div class="col-sm-12 col-md-7">
                                        <div class="dataTables_paginate paging_simple_numbers" id="pagination"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- 引入通用的页脚 -->
    <div th:replace="common/footer :: footer"></div>
</div>

<!-- jQuery -->
<script src="/AdminLTE/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="/AdminLTE/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js -->
<script src="/AdminLTE/plugins/chart.js/Chart.min.js"></script>
<!-- AdminLTE App -->
<script src="/AdminLTE/dist/js/adminlte.min.js"></script>

<script>
let taskId = '';
let currentPage = 1;
let pageSize = 10;
let responseTimeChart = null;
let availabilityChart = null;

$(document).ready(function() {
    // 获取任务ID
    const pathSegments = window.location.pathname.split('/');
    if (pathSegments.length > 3) {
        taskId = pathSegments[3];
        loadTaskData();
        loadStatistics();
        loadChartData();
        loadResults();
        loadRealtimeStatus();
        
        // 定时刷新实时状态
        setInterval(loadRealtimeStatus, 30000); // 30秒刷新一次
    }
    
    // 时间范围变化时重新加载图表
    $('#chartTimeRange').on('change', function() {
        loadChartData();
    });
    
    // 筛选变化时重新加载结果
    $('#filterIp, #filterStatus').on('change', function() {
        currentPage = 1;
        loadResults();
    });
});

// 加载任务基本信息
function loadTaskData() {
    $.ajax({
        url: '/ping/get/' + taskId,
        type: 'GET',
        success: function(response) {
            if (response.success) {
                displayTaskInfo(response.data);
            } else {
                alert('加载任务数据失败: ' + response.message);
            }
        },
        error: function() {
            alert('服务器连接失败');
        }
    });
}

// 显示任务信息
function displayTaskInfo(task) {
    $('#taskTitle').text(task.taskName + ' - 任务详情');
    $('#taskName').text(task.taskName);
    $('#taskDescription').text(task.description || '无');
    $('#pingInterval').text(task.pingInterval + ' 秒');
    $('#timeout').text(task.timeout + ' 毫秒');
    
    const statusClass = task.isEnabled ? 'status-online' : 'status-disabled';
    const statusText = task.isEnabled ? '启用' : '禁用';
    $('#taskStatus').html(`<span class="${statusClass}">${statusText}</span>`);
    
    const recordText = task.recordAllResults ? '记录所有结果' : '仅记录失败';
    $('#recordStrategy').text(recordText);
    $('#createTime').text(task.createTime);
    
    // 处理IP列表
    const ips = task.ipList.split(',');
    let ipHtml = '';
    ips.forEach(ip => {
        ipHtml += `<span class="badge badge-secondary mr-1">${ip.trim()}</span>`;
    });
    $('#ipList').html(ipHtml);
    
    // 更新IP筛选下拉框
    const filterIp = $('#filterIp');
    filterIp.empty().append('<option value="">所有IP</option>');
    ips.forEach(ip => {
        filterIp.append(`<option value="${ip.trim()}">${ip.trim()}</option>`);
    });
    
    // 处理标签
    if (task.tags && task.tags.trim()) {
        const tags = task.tags.split(',');
        let tagHtml = '';
        tags.forEach(tag => {
            tagHtml += `<span class="badge badge-info mr-1">${tag.trim()}</span>`;
        });
        $('#tags').html(tagHtml);
        $('#tagsRow').show();
    }
}

// 加载实时状态
function loadRealtimeStatus() {
    $.ajax({
        url: '/ping/status/' + taskId,
        type: 'GET',
        success: function(response) {
            if (response.success) {
                displayRealtimeStatus(response.data);
            }
        },
        error: function() {
            $('#realtimeStatus').html('<div class="text-danger">加载失败</div>');
        }
    });
}

// 显示实时状态
function displayRealtimeStatus(data) {
    let html = '';
    
    // 线程状态
    if (data.threadStatus) {
        const threadClass = data.threadStatus.running ? 'status-online' : 'status-offline';
        const threadText = data.threadStatus.running ? '运行中' : '已停止';
        html += `<div class="mb-2"><strong>线程状态:</strong> <span class="${threadClass}">${threadText}</span></div>`;
        
        if (data.threadStatus.running) {
            html += `<div class="mb-2"><strong>运行时长:</strong> ${data.threadStatus.runningTime}</div>`;
        }
    }
    
    // 最新结果
    if (data.latestResults && data.latestResults.length > 0) {
        html += '<hr><strong>最新状态:</strong><div class="mt-2">';
        data.latestResults.forEach(result => {
            const statusClass = result.is_reachable ? 'status-online' : 'status-offline';
            const statusText = result.is_reachable ? '可达' : '不可达';
            const responseTime = result.is_reachable ? result.response_time + 'ms' : '-';
            
            html += `
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span>${result.target_ip}</span>
                    <span class="${statusClass}">${statusText} (${responseTime})</span>
                </div>
            `;
        });
        html += '</div>';
    }
    
    $('#realtimeStatus').html(html);
    
    // 更新线程状态显示
    if (data.threadStatus) {
        const threadClass = data.threadStatus.running ? 'status-online' : 'status-offline';
        const threadText = data.threadStatus.running ? '运行中' : '已停止';
        $('#threadStatus').html(`<span class="${threadClass}">${threadText}</span>`);
    }
}

// 加载统计信息
function loadStatistics() {
    $.ajax({
        url: '/ping/statistics/' + taskId,
        type: 'GET',
        data: { hours: 24 }, // 最近24小时的统计
        success: function(response) {
            if (response.success) {
                displayStatistics(response.data);
            }
        },
        error: function() {
            console.error('加载统计信息失败');
        }
    });
}

// 显示统计信息
function displayStatistics(stats) {
    if (stats && stats.length > 0) {
        let totalPings = 0;
        let totalSuccess = 0;
        let totalResponseTime = 0;
        let responseCount = 0;
        
        stats.forEach(stat => {
            totalPings += stat.total_count || 0;
            totalSuccess += stat.success_count || 0;
            if (stat.avg_response_time) {
                totalResponseTime += stat.avg_response_time;
                responseCount++;
            }
        });
        
        const successRate = totalPings > 0 ? ((totalSuccess / totalPings) * 100).toFixed(1) : 0;
        const avgResponseTime = responseCount > 0 ? (totalResponseTime / responseCount).toFixed(0) : 0;
        
        $('#totalPings').text(totalPings);
        $('#successRate').text(successRate + '%');
        $('#avgResponseTime').text(avgResponseTime + 'ms');
    } else {
        $('#totalPings').text('0');
        $('#successRate').text('0%');
        $('#avgResponseTime').text('0ms');
    }
    
    // 最后失败时间需要单独获取
    loadLastFailure();
}

// 获取最后失败时间
function loadLastFailure() {
    $.ajax({
        url: '/ping/lastFailure/' + taskId,
        type: 'GET',
        success: function(response) {
            if (response.success && response.data) {
                $('#lastFailure').text(response.data);
            } else {
                $('#lastFailure').text('无');
            }
        },
        error: function() {
            $('#lastFailure').text('无法获取');
        }
    });
}

// 加载图表数据
function loadChartData() {
    const hours = $('#chartTimeRange').val();
    
    $.ajax({
        url: '/ping/chartData/' + taskId,
        type: 'GET',
        data: { hours: hours },
        success: function(response) {
            if (response.success) {
                renderCharts(response.data);
            }
        },
        error: function() {
            console.error('加载图表数据失败');
        }
    });
}

// 渲染图表
function renderCharts(data) {
    // 准备图表数据
    const labels = [];
    const datasets = {};
    
    if (data && data.length > 0) {
        data.forEach(item => {
            if (labels.indexOf(item.time_point) === -1) {
                labels.push(item.time_point);
            }
            
            if (!datasets[item.target_ip]) {
                datasets[item.target_ip] = {
                    responseTime: [],
                    availability: []
                };
            }
            
            datasets[item.target_ip].responseTime.push(item.avg_response_time || 0);
            datasets[item.target_ip].availability.push(item.availability || 0);
        });
    }
    
    // 响应时间图表
    renderResponseTimeChart(labels, datasets);
    
    // 可用性图表
    renderAvailabilityChart(labels, datasets);
}

// 渲染响应时间图表
function renderResponseTimeChart(labels, datasets) {
    const ctx = document.getElementById('responseTimeChart').getContext('2d');
    
    if (responseTimeChart) {
        responseTimeChart.destroy();
    }
    
    const chartDatasets = [];
    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'];
    let colorIndex = 0;
    
    Object.keys(datasets).forEach(ip => {
        chartDatasets.push({
            label: ip,
            data: datasets[ip].responseTime,
            borderColor: colors[colorIndex % colors.length],
            backgroundColor: colors[colorIndex % colors.length] + '20',
            fill: false,
            tension: 0.1
        });
        colorIndex++;
    });
    
    responseTimeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: chartDatasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '响应时间 (ms)'
                    }
                }
            }
        }
    });
}

// 渲染可用性图表
function renderAvailabilityChart(labels, datasets) {
    const ctx = document.getElementById('availabilityChart').getContext('2d');
    
    if (availabilityChart) {
        availabilityChart.destroy();
    }
    
    const chartDatasets = [];
    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'];
    let colorIndex = 0;
    
    Object.keys(datasets).forEach(ip => {
        chartDatasets.push({
            label: ip,
            data: datasets[ip].availability,
            borderColor: colors[colorIndex % colors.length],
            backgroundColor: colors[colorIndex % colors.length] + '20',
            fill: false,
            tension: 0.1
        });
        colorIndex++;
    });
    
    availabilityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: chartDatasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: '可用性 (%)'
                    }
                }
            }
        }
    });
}

// 加载监测结果
function loadResults() {
    const filterIp = $('#filterIp').val();
    const filterStatus = $('#filterStatus').val();
    
    $.ajax({
        url: '/ping/results/' + taskId,
        type: 'GET',
        data: {
            targetIp: filterIp,
            isReachable: filterStatus,
            page: currentPage,
            size: pageSize
        },
        success: function(response) {
            if (response.success) {
                renderResultsTable(response.data.data);
                renderResultsPagination(response.data.total, response.data.page, response.data.size);
            }
        },
        error: function() {
            console.error('加载监测结果失败');
        }
    });
}

// 渲染结果表格
function renderResultsTable(results) {
    const tbody = $('#resultsTableBody');
    tbody.empty();
    
    if (!results || results.length === 0) {
        tbody.append('<tr><td colspan="6" class="text-center">暂无数据</td></tr>');
        return;
    }
    
    results.forEach(result => {
        const statusClass = result.isReachable ? 'status-online' : 'status-offline';
        const statusText = result.isReachable ? '可达' : '不可达';
        const responseTime = result.isReachable ? result.responseTime + 'ms' : '-';
        const packetLoss = result.packetLoss ? result.packetLoss + '%' : '0%';
        const errorMsg = result.errorMessage || '-';
        
        const row = `
            <tr>
                <td>${result.targetIp}</td>
                <td><span class="${statusClass}">${statusText}</span></td>
                <td>${responseTime}</td>
                <td>${packetLoss}</td>
                <td>${result.pingTime}</td>
                <td>${errorMsg}</td>
            </tr>
        `;
        tbody.append(row);
    });
}

// 渲染结果分页
function renderResultsPagination(total, page, size) {
    const totalPages = Math.ceil(total / size);
    const pageInfo = `显示第 ${(page - 1) * size + 1} 到 ${Math.min(page * size, total)} 条记录，共 ${total} 条`;
    $('#pageInfo').text(pageInfo);
    
    const pagination = $('#pagination');
    pagination.empty();
    
    if (totalPages <= 1) return;
    
    let paginationHtml = '<ul class="pagination">';
    
    // 上一页
    if (page > 1) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="changeResultsPage(${page - 1})">上一页</a></li>`;
    }
    
    // 页码
    const startPage = Math.max(1, page - 2);
    const endPage = Math.min(totalPages, page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === page ? 'active' : '';
        paginationHtml += `<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="changeResultsPage(${i})">${i}</a></li>`;
    }
    
    // 下一页
    if (page < totalPages) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="changeResultsPage(${page + 1})">下一页</a></li>`;
    }
    
    paginationHtml += '</ul>';
    pagination.html(paginationHtml);
}

// 结果页面跳转
function changeResultsPage(page) {
    currentPage = page;
    loadResults();
}

// 编辑任务
function editTask() {
    window.location.href = '/ping/edit/' + taskId;
}

// 立即测试
function testPing() {
    $('#testBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 测试中...');
    
    $.ajax({
        url: '/ping/test/' + taskId,
        type: 'POST',
        success: function(response) {
            if (response.success) {
                alert('测试完成');
                refreshData();
            } else {
                alert('测试失败: ' + response.message);
            }
        },
        error: function() {
            alert('服务器连接失败');
        },
        complete: function() {
            $('#testBtn').prop('disabled', false).html('<i class="fas fa-network-wired"></i> 立即测试');
        }
    });
}

// 刷新数据
function refreshData() {
    loadTaskData();
    loadStatistics();
    loadChartData();
    loadResults();
    loadRealtimeStatus();
}
</script>
</body>
</html> 