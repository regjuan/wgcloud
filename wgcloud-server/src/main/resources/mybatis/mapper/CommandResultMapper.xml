<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wgcloud.mapper.CommandResultMapper">

    <resultMap id="resultMap" type="com.wgcloud.entity.CommandResult">
        <id column="ID" property="id" jdbcType="CHAR" />
        <result column="TASK_ID" property="taskId" jdbcType="VARCHAR" />
        <result column="COMMAND_ID" property="commandId" jdbcType="VARCHAR" />
        <result column="HOSTNAME" property="hostname" jdbcType="VARCHAR" />
        <result column="STATUS" property="status" jdbcType="VARCHAR" />
        <result column="STDOUT" property="stdout" jdbcType="VARCHAR" />
        <result column="STDERR" property="stderr" jdbcType="VARCHAR" />
        <result column="EXIT_CODE" property="exitCode" jdbcType="INTEGER" />
        <result column="START_TIME" property="startTime" jdbcType="TIMESTAMP" />
        <result column="END_TIME" property="endTime" jdbcType="TIMESTAMP" />
        <result column="EXPIRE_TIME" property="expireTime" jdbcType="TIMESTAMP" />
    </resultMap>

    <sql id="tableColumnList">
        ID, TASK_ID, COMMAND_ID, HOSTNAME, STATUS, STDOUT, STDERR, EXIT_CODE, START_TIME, END_TIME,EXPIRE_TIME
    </sql>

    <sql id="queryByParams">
        <if test="hostname != null">
            <![CDATA[ AND HOSTNAME LIKE CONCAT('%',#{hostname},'%') ]]>
        </if>
        <if test="status != null">
            AND STATUS = #{status}
        </if>
        <if test="taskId != null">
            AND TASK_ID = #{taskId}
        </if>
        <if test="startTime != null">
            AND START_TIME = #{startTime}
        </if>
    </sql>

    <select id="selectByParams" parameterType="map" resultMap="resultMap">
        SELECT
        <include refid="tableColumnList" />
        FROM COMMAND_RESULT
        <where>
            <include refid="queryByParams" />
        </where>
        ORDER BY START_TIME DESC
    </select>

    <select id="countByParams" parameterType="map" resultType="java.lang.Integer">
        SELECT count(*) FROM COMMAND_RESULT
        <where>
            <include refid="queryByParams" />
        </where>
    </select>

    <insert id="save" parameterType="com.wgcloud.entity.CommandResult">
        INSERT INTO COMMAND_RESULT (ID, TASK_ID, COMMAND_ID, HOSTNAME, STATUS, STDOUT, STDERR, EXIT_CODE, START_TIME, END_TIME,EXPIRE_TIME)
        VALUES (#{id}, #{taskId}, #{commandId}, #{hostname}, #{status}, #{stdout}, #{stderr}, #{exitCode}, #{startTime}, #{endTime},#{expireTime})
    </insert>

    <delete id="deleteById" parameterType="java.lang.String">
        DELETE FROM COMMAND_RESULT WHERE ID IN
        <foreach item="item" index="index" collection="array" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <update id="updateById" parameterType="com.wgcloud.entity.CommandResult">
        UPDATE COMMAND_RESULT
        <set>
            <if test="status != null">STATUS = #{status},</if>
            <if test="stdout != null">STDOUT = #{stdout},</if>
            <if test="stderr != null">STDERR = #{stderr},</if>
            <if test="exitCode != null">EXIT_CODE = #{exitCode},</if>
            <if test="startTime != null">START_TIME = #{startTime},</if>
            <if test="endTime != null">END_TIME = #{endTime},</if>
            <if test="expireTime != null">EXPIRE_TIME = #{expireTime},</if>
        </set>
        WHERE ID = #{id}
    </update>

    <update id="updateExpiredTasks">
        UPDATE COMMAND_RESULT
        SET STATUS = 'TIMEOUT'
        WHERE STATUS = 'PENDING'
          AND EXPIRE_TIME IS NOT NULL
          AND EXPIRE_TIME &lt; NOW()
    </update>

    <resultMap id="playbookHisDtoResultMap" type="com.wgcloud.dto.PlaybookHisDto">
        <result column="playbookId" property="playbookId" jdbcType="VARCHAR" />
        <result column="playbookName" property="playbookName" jdbcType="VARCHAR" />
        <result column="startTime" property="startTime" jdbcType="TIMESTAMP" />
        <result column="totalSteps" property="totalSteps" jdbcType="INTEGER" />
        <result column="successSteps" property="successSteps" jdbcType="INTEGER" />
        <result column="failedSteps" property="failedSteps" jdbcType="INTEGER" />
        <result column="pendingSteps" property="pendingSteps" jdbcType="INTEGER" />
        <result column="runningSteps" property="runningSteps" jdbcType="INTEGER" />
        <result column="timeoutSteps" property="timeoutSteps" jdbcType="INTEGER" />
    </resultMap>

    <select id="selectHisByParams" parameterType="map" resultMap="playbookHisDtoResultMap">
        SELECT
            cr.TASK_ID as playbookId,
            p.PLAYBOOK_NAME as playbookName,
            cr.START_TIME as startTime,
            COUNT(*) as totalSteps,
            SUM(CASE WHEN cr.STATUS = 'SUCCESS' THEN 1 ELSE 0 END) as successSteps,
            SUM(CASE WHEN cr.STATUS = 'FAILED' THEN 1 ELSE 0 END) as failedSteps,
            SUM(CASE WHEN cr.STATUS = 'PENDING' THEN 1 ELSE 0 END) as pendingSteps,
            SUM(CASE WHEN cr.STATUS = 'RUNNING' THEN 1 ELSE 0 END) as runningSteps,
            SUM(CASE WHEN cr.STATUS = 'TIMEOUT' THEN 1 ELSE 0 END) as timeoutSteps
        FROM
            COMMAND_RESULT cr
        LEFT JOIN
            PLAYBOOK p ON cr.TASK_ID = p.ID
        <where>
            <if test="taskId != null and taskId != ''">
                AND cr.TASK_ID = #{taskId}
            </if>
        </where>
        GROUP BY
            cr.TASK_ID, cr.START_TIME, p.PLAYBOOK_NAME
        ORDER BY
            cr.START_TIME DESC
    </select>

</mapper>
